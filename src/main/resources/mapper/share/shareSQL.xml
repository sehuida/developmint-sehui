<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="share">
   <insert id="insertShare" parameterType="sv">
   		insert into share_board values 
   		(share_seq.nextval,#{memberNo},#{boardTitle},#{boardContent},#{boardType}, TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS'),#{filename},#{filepath},0)
   </insert>
   <update id="plusPoints" parameterType="sv">
   		update member set member_grade = member_grade+3 where member_no=#{memberNo}
   </update>
   <select id="shareList" parameterType="map" resultType="sv">
		select shb.* from
		(select rownum as rnum,sb.* from
		(select 
		    member_no as memberNo,
		    board_no as boardNo,
		    board_title as boardtitle,
		    board_content as boardContent,
		    board_type as boardType,
		    reg_date as regDate,
		    filename,
		    s.filepath,
		    read_count as readCount,
		    member_id as memberId,
		    m.filepath as profiles,
		    member_grade as memberGrade,
		    (select count(*) from likes lk where s.board_no=lk.board_no) as likes,
		    (select count(*) from comments c where c.board_no=s.board_no and c.board_type=2) as comments
		from share_board s left join member m using (member_no) 
		order by 
		 <choose> 
		 	<when test="type == 1">
		 		board_no
		 	</when>
		 	<when test="type == 2">
		 		likes
		 	</when>
		 	<when test="type == 3">
		 		read_count
		 	</when>
		 	<when test="type == 4">
		 		comments
		 	</when>	 	
		 </choose>		
		 desc)sb)shb where rnum between #{start} and #{end}  	
   </select>
   <select id="shareCount" resultType="_int">
   		select count(*) from share_board		
   </select>
   <select id="searchBoard" parameterType="map" resultType="sv">
		select shb.* from
		(select rownum as rnum,sb.* from
		(select 
		    member_no as memberNo,
		    board_no as boardNo,
		    board_title as boardtitle,
		    board_content as boardContent,
		    board_type as boardType,
		    reg_date as regDate,
		    filename,
		    s.filepath,
		    read_count as readCount,
		    member_id as memberId,
		    m.filepath as profiles,
		    member_grade as memberGrade,
		    (select count(*) from likes lk where s.board_no=lk.board_no) as likes,
		    (select count(*) from comments c where c.board_no=s.board_no and c.board_type=2) as comments
		from share_board s left join member m using (member_no)
		<trim prefix="where">
			<if test="category == 1">
				  s.board_title like '%'||#{search}||'%'		
			</if>
			<if test="category == 2">
				   m.member_id like '%'||#{search}||'%'
			</if>
		</trim>

		order by 1 desc)sb)shb where rnum between #{start} and #{end}      
   </select>
   <select id="shareBoardView" parameterType="_int" resultType="sv">
		select 
				    member_no as memberNo,
				    board_no as boardNo,
				    board_title as boardtitle,
				    board_content as boardContent,
				    board_type as boardType,
				    reg_date as regDate,
				    filename,
				    s.filepath,
				    read_count as readCount,
				    member_id as memberId,
				    m.filepath as profiles,
				    member_grade as memberGrade,
				    (select count(*) from likes lk where s.board_no=lk.board_no) as likes,
				    (select count(*) from comments c where c.board_no=s.board_no and c.board_type=2) as comments
				from share_board s left join member m using (member_no) where s.board_no=#{boardNo}   
   </select>
   <select id="shareComments" parameterType="_int" resultType="cm">
		select
		    comment_no as commentNo,
		    member_id as memberId,
		    comment_content as commentContent,
		    reg_date as regDate,
		    board_no as boradNO,
		    board_type as boardType,
		    comment_type as commentType,
		    comment_ref as commentRef
		from comments where board_type = 2 and board_no=#{boardNo}   		
   </select>
   <update id="updateCount" parameterType="_int">
		update share_board set read_count = read_count+1 where board_no=#{boardNo}
   </update>
</mapper>
